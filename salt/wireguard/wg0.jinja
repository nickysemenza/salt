{% set host = grains.get('host') %}
{% set port = pillar.get('ports')['wireguard'] %} 

{% set node_role = pillar.roles[host] %}
{# minions that conenct: #}
{% if host == 'pecan' %}
[Interface]
PrivateKey = {{pillar.wireguard[host].privkey}}
Address = {{pillar.roles[host].wg_ip}}/24
PostUp = iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; sysctl net.ipv4.ip_forward=1
PostDown = iptables -t nat -D POSTROUTING -o etho0 -j MASQUERADE

[Peer]
PublicKey = {{pillar.wireguard['salt-01'].pubkey}}
AllowedIPs = 172.16.0.0/24
Endpoint = {{pillar.roles['salt-01'].public_ip}}:{{port}}
PersistentKeepalive = 20

{# master node: #}
{% elif node_role.wireguard == 'server' %}
[Interface]
PrivateKey = {{pillar.wireguard[host].privkey}}
ListenPort = {{port}}
Address = 172.16.0.2/24

[Peer]
PublicKey =  {{pillar.wireguard['pecan'].pubkey}}
AllowedIPs = {{pillar.roles['pecan'].wg_ip}}/32, 10.0.0.0/24
{% endif %}